#!/usr/bin/env bash
set -euo pipefail

# –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è *.webm/*.mp4 ‚Üí *.flac
# –° –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –∏ –æ–±–ª–æ–∂–∫–æ–π (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∏–ª–∏ –≤–Ω–µ—à–Ω–µ–π)

find . -type f \( -iname '*.webm' -o -iname '*.mp4' \) -print0 |
while IFS= read -r -d '' file; do
  base="${file%.*}"
  out="${base}.flac"

  if [[ -e "$out" ]]; then
    echo "‚è≠Ô∏è  –£–∂–µ –µ—Å—Ç—å, –ø—Ä–æ–ø—É—Å–∫–∞—é: $out"
    continue
  fi

  echo "üéß –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é: $file ‚Üí $out"

  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –æ–±–ª–æ–∂–∫—É
  has_cover=$(ffprobe -v error -select_streams v \
    -show_entries stream_tags=handler_name \
    -of default=noprint_wrappers=1:nokey=1 "$file" | grep -qi "cover" && echo yes || echo no)

  # –ò—â–µ–º –≤–Ω–µ—à–Ω—é—é –æ–±–ª–æ–∂–∫—É –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ
  dir=$(dirname "$file")
  for ext in jpg jpeg png; do
    if [[ -f "$dir/cover.$ext" ]]; then
      cover_file="$dir/cover.$ext"
      break
    elif [[ -f "$dir/folder.$ext" ]]; then
      cover_file="$dir/folder.$ext"
      break
    fi
  done

  # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É ffmpeg
  if [[ "$has_cover" == "yes" ]]; then
    ffmpeg -hide_banner -n \
      -i "$file" \
      -map_metadata 0 \
      -map 0:a:0 \
      -map 0:v \
      -c:a flac -compression_level 5 \
      -c:v copy \
      "$out"
  elif [[ -n "${cover_file-}" ]]; then
    ffmpeg -hide_banner -n \
      -i "$file" \
      -i "$cover_file" \
      -map_metadata 0 \
      -map 0:a:0 \
      -map 1:0 \
      -c:a flac -compression_level 5 \
      -c:v:1 copy \
      -disposition:v:0 attached_pic \
      "$out"
  else
    ffmpeg -hide_banner -n \
      -i "$file" \
      -map_metadata 0 \
      -map 0:a:0 \
      -c:a flac -compression_level 5 \
      "$out"
  fi

done
